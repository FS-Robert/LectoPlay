{% extends 'home.html' %}

{% block title %}Ejercicios | LectoPlay{% endblock %}

{% block content %}

<style>
    /* Bot√≥n flotante para activar narrador */
    #tts-btn {
        position: fixed;
        bottom: 30px;
        left: 30px;
        background: #ffafcc;
        padding: 15px 25px;
        border-radius: 50px;
        font-size: 16px;
        border: none;
        cursor: pointer;
        font-weight: bold;
        box-shadow: 0px 4px 6px rgba(0,0,0,0.3);
        z-index: 9999;
    }
</style>

<button id="tts-btn" onclick="activarTTS()">üîä Activar narrador</button>

<section class="ejercicios">
    <h1>üß© Ejercicios Divertidos</h1>
    <p>Aprende y juega con estos ejercicios interactivos.</p>

    <button onclick="leerTexto('Ejercicios Divertidos. Aprende y juega con estos ejercicios interactivos.')">
        üîä Escuchar de nuevo
    </button>

    <div class="cards">
        <div class="card">
            <h3>üìñ Lectura R√°pida</h3>
            <p>Lee frases cortas y responde preguntas para mejorar tu comprensi√≥n.</p>
            <a href="{% url 'lectura_rapida_game' %}" class="btn">Jugar</a>
        </div>
        <div class="card">
            <h3>üé® Palabras y Colores</h3>
            <p>Asocia palabras con colores.</p>
            <a href="{% url 'palabras_colores' %}" class="btn">Jugar</a>
        </div>
        <div class="card">
            <h3>üî§ Encuentra la Letra</h3>
            <p>Identifica letras escondidas.</p>
            <a href="{% url 'encuentra' %}" class="btn">Jugar</a>
        </div>
        <div class="card">
            <h3>‚úèÔ∏è Escribe la Palabra</h3>
            <p>Lee una descripci√≥n y escribe la palabra correcta.</p>
            <a href="{% url 'desc_palabra' %}" class="btn">Jugar</a>
        </div>
        <div class="card">
            <h3>‚úÖ Palabra o no palabra</h3>
            <p>Diferencia palabras reales e inventadas.</p>
            <a href="{% url 'pnp' %}" class="btn">Jugar</a>
        </div>
    </div>
</section>

{% endblock %}

{% block extra_js %}
<script>
// Variable global para referencia del audio actual
window.currentUtterance = null;

/**
 * Funci√≥n recursiva para narrar una lista de mensajes.
 * Recibe el bot√≥n (ttsBtn) para restaurar el texto cuando termine la lista.
 */
function narrarSecuencia(lista, ttsBtn) {
    // Caso base: si la lista est√° vac√≠a, terminamos
    if (lista.length === 0) {
        console.log("Secuencia terminada.");
        // Restaurar el bot√≥n al estado original
        if (ttsBtn) {
            ttsBtn.textContent = 'üîä Activar narrador';
        }
        return;
    }

    console.log("Reproduciendo:", lista[0]);

    // Crear la instancia de voz
    window.currentUtterance = new SpeechSynthesisUtterance(lista[0]);
    window.currentUtterance.lang = "es-ES";
    window.currentUtterance.rate = 0.9; // Velocidad ligeramente m√°s lenta

    // Evento: Al terminar este audio, reproducir el siguiente (recursi√≥n)
    window.currentUtterance.onend = function() {
        narrarSecuencia(lista.slice(1), ttsBtn);
    };

    // Evento: Manejo de errores (intenta seguir con el siguiente)
    window.currentUtterance.onerror = function(event) {
        console.error("Error en TTS:", event);
        narrarSecuencia(lista.slice(1), ttsBtn);
    };

    // Hablar
    window.speechSynthesis.speak(window.currentUtterance);
}

/**
 * Funci√≥n simple para leer un texto puntual (botones de ayuda)
 */
function leerTexto(texto) {
    window.speechSynthesis.cancel(); // Detiene cualquier narraci√≥n en curso
    
    // Si la narraci√≥n global estaba activa, reseteamos el bot√≥n grande
    const ttsBtn = document.getElementById('tts-btn');
    if (ttsBtn && ttsBtn.textContent.includes('Desactivar')) {
        ttsBtn.textContent = 'üîä Activar narrador';
    }

    const speech = new SpeechSynthesisUtterance(texto);
    speech.lang = "es-ES";
    window.speechSynthesis.speak(speech);
}

/**
 * Funci√≥n principal del bot√≥n flotante (Toggle Activar/Desactivar)
 */
function activarTTS() {
    const ttsBtn = document.getElementById('tts-btn');
    
    // CASO 1: Si ya est√° narrando (el bot√≥n dice "Desactivar"), lo paramos.
    if (ttsBtn.textContent.includes('Desactivar')) {
        window.speechSynthesis.cancel();
        ttsBtn.textContent = 'üîä Activar narrador';
        console.log("Narrador detenido por el usuario.");
        return;
    }

    // CASO 2: Iniciar narraci√≥n
    console.log("Iniciando narrador...");
    window.speechSynthesis.cancel(); // Limpieza preventiva
    
    // Cambiar estado del bot√≥n
    ttsBtn.textContent = 'üõë Desactivar narrador';

    const mensajes = [
        "Ejercicios Divertidos. Aprende y juega con estos ejercicios interactivos.",
        "Elige entre los distintos ejercicios.",
        "Lectura R√°pida: lee frases cortas y responde preguntas.",
        "Palabras y Colores: asocia palabras con colores.",
        "Encuentra la Letra: identifica letras escondidas.",
        "Escribe la Palabra: lee una descripci√≥n y escribe la palabra correcta.",
        "Palabra o no palabra: diferencia palabras reales e inventadas.",
        "Divi√©rtete aprendiendo con los ejercicios."
    ];

    // Iniciar secuencia pasando el bot√≥n para resetearlo al final
    narrarSecuencia(mensajes, ttsBtn);
}
</script>

<script>
// Detener voz si el usuario cambia de p√°gina o recarga
window.addEventListener("beforeunload", function () {
    window.speechSynthesis.cancel();
});
</script>
{% endblock %}