{% extends "home.html" %}
{% load static %}

{% block title %}Escribe la Palabra | LectoPlay{% endblock %}

{% block content %}

<div class="container py-5">
    
    <div class="text-center mb-4">
        <h1 class="fw-bold" style="color: #9d4edd;">Escribe la Palabra</h1>
        <p class="lead text-muted">Lee la descripción y escribe la respuesta correcta.</p>
    </div>

    {% if finished %}
        <div class="game-bg-write text-center">
            <h2 class="fw-bold text-success mb-3" style="font-size: 2.5rem;">¡Juego Completado!</h2>
            
            <div class="p-4 bg-white rounded-4 shadow-sm d-inline-block mb-4">
                <p class="mb-0 fs-4 text-secondary">Puntuación Final</p>
                <p class="display-4 fw-bold" style="color: #9d4edd;">{{ score }} <span class="fs-4 text-muted">/ {{ total }}</span></p>
            </div>

            <form method="post">
                {% csrf_token %}
                <button name="reset" value="1" class="btn btn-lg text-white rounded-pill px-5 fw-bold shadow-sm" style="background-color: #9d4edd;">
                    Jugar de nuevo
                </button>
            </form>
        </div>

    {% else %}
        <div class="game-bg-write text-center">
            
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="badge bg-light text-dark border px-3 py-2 rounded-pill fs-6">
                    Nivel {{ level_num }} / {{ total }}
                </span>
                <span class="badge bg-warning text-dark px-3 py-2 rounded-pill fs-6">
                    Puntos: {{ score }}
                </span>
            </div>

            <div class="desc-box text-start">
                <h5 class="fw-bold text-uppercase mb-2" style="color: #9d4edd; font-size: 0.9rem;">Pista:</h5>
                <p class="desc-text" id="descripcion-texto">{{ descripcion }}</p>
            </div>

            <form method="post" autocomplete="off">
                {% csrf_token %}
                
                <div class="mb-4">
                    <label for="respuesta" class="form-label visually-hidden">Tu respuesta</label>
                    <input type="text" id="respuesta" name="respuesta" 
                           class="write-input" 
                           placeholder="Escribe aquí..." autofocus required>
                </div>

                <button type="submit" class="btn btn-lg text-white rounded-pill px-5 fw-bold shadow-sm" style="background-color: #9d4edd;">
                    Comprobar
                </button>
            </form>

            {% if message %}
                <div class="mt-4 alert alert-danger fw-bold d-inline-block px-4 py-2 rounded-pill animate__animated animate__shakeX">
                    {{ message }}
                </div>
            {% endif %}
            
            <form method="post" class="mt-4">
                {% csrf_token %}
                <button name="reset" value="1" class="btn btn-sm btn-link text-muted text-decoration-none">
                    Reiniciar juego
                </button>
            </form>
        </div>
    {% endif %}

</div>

<button id="btnNarracion" onclick="toggleNarracion()"
    class="shadow"
    style="
        position: fixed; left: 20px; bottom: 20px; padding: 12px 20px;
        background-color: #ff85c0; border: none; border-radius: 50px;
        font-weight: bold; color: white; cursor: pointer; z-index: 999;
        transition: 0.3s; font-size: 0.9rem;
    ">
    Narrador Desactivado
</button>

{% endblock %}

{% block extra_js %}
<script>
    // Estado de TTS persistente
    let narracionActiva = localStorage.getItem("narracionActiva") === "true";
    
    // Variables seguras
    const isFinished = "{{ finished|yesno:'true,false' }}" === "true";
    const level = {{ level_num|default:"0" }};
    const message = "{{ message|default:''|escapejs }}";
    
    const descEl = document.getElementById("descripcion-texto");
    const descripcion = descEl ? descEl.textContent.trim() : "";

    const btn = document.getElementById("btnNarracion");

    // Actualizar boton
    function updateButton() {
        if(btn) {
            btn.textContent = narracionActiva ? "Narrador Activado" : "Narrador Desactivado";
            btn.style.backgroundColor = narracionActiva ? "#4cc9f0" : "#ff85c0";
        }
    }
    updateButton();

    // Toggle Narracion
    function toggleNarracion() {
        narracionActiva = !narracionActiva;
        localStorage.setItem("narracionActiva", narracionActiva);
        updateButton();
        
        if (!narracionActiva) {
            window.speechSynthesis.cancel();
        } else {
            leerEstadoJuego();
        }
    }

    // Funcion TTS basica
    function leerTexto(text) {
        if (!narracionActiva) return;
        if (!('speechSynthesis' in window)) return;

        // No cancelamos aqui si es parte de una secuencia
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = "es-ES";
        msg.rate = 0.9; 
        window.speechSynthesis.speak(msg);
    }

    // Logica de lectura secuencial
    function leerEstadoJuego() {
        // Cancelamos cualquier audio previo
        window.speechSynthesis.cancel();

        if (isFinished) {
            leerTexto("Juego completado. Felicidades.");
            return;
        }

        // 1. Si hay mensaje de error/feedback, leerlo primero
        if (message) {
            leerTexto(message); 
            // Despues leer la pista de nuevo
            leerTexto("La pista es: " + descripcion);
        } else {
            // Si es un nivel nuevo (sin error previo)
            if (level === 1) {
                // Lectura completa de bienvenida y reglas en Nivel 1
                leerTexto(`Bienvenido a Escribe la palabra. Lee la descripción y escribe la respuesta correcta. Nivel 1. Pista: ${descripcion}`);
            } else {
                // Niveles siguientes: solo pista
                leerTexto(`Pista: ${descripcion}`);
            }
        }
    }

    // Al cargar la pagina
    setTimeout(() => {
        if (narracionActiva) {
            leerEstadoJuego();
        }
    }, 500);

    // Detener al salir
    window.addEventListener("beforeunload", () => {
        window.speechSynthesis.cancel();
    });
</script>
{% endblock %}