{% extends "home.html" %}

{% block title %}Escribe la Palabra | LectoPlay{% endblock %}

{% block content %}
<section class="ejercicios">
    <h1>锔 Escribe la palabra</h1>
    <p>Lee la descripci贸n y escribe la palabra correcta.</p>

    {% if finished %}
        <div class="lectura-bg">
            <div class="lectura-card" style="text-align:center;">
                <p>Has completado el juego.</p>
                <p>Puntuaci贸n final: <strong>{{ score }}</strong> / {{ total }}</p>
                <form method="post">
                    {% csrf_token %}
                    <button type="submit" name="reset" value="1" class="btn">Jugar de nuevo</button>
                </form>
            </div>
        </div>
    {% else %}
        <div class="lectura-bg">
            <div class="score-pretty">
                Nivel {{ level_num }} / {{ total }} &nbsp; | &nbsp; Puntos: {{ score }}
            </div>

            <div class="lectura-card">
                <h2 class="titulo-categoria">Escribe la palabra</h2>

                <div class="frase-box-pretty">
                    <strong>Descripci贸n:</strong>
                    <p>{{ descripcion }}</p>
                </div>

                <form method="post">
                    {% csrf_token %}
                    <label for="respuesta"><strong>Tu respuesta:</strong></label><br>
                    <input
                        type="text"
                        id="respuesta"
                        name="respuesta"
                        autocomplete="off"
                        style="margin-top:6px; padding:8px; border-radius:8px;
                               border:2px solid #ffd166; width:70%; max-width:260px;">

                    <div class="btn-row">
                        <button type="submit" class="btn">Comprobar</button>
                    </div>
                </form>

                {% if message %}
                    <p class="feedback">{{ message }}</p>
                {% endif %}
            </div>
        </div>
    {% endif %}
</section>

<!--  BOTN FLOTANTE -->
<button id="btnNarracion" onclick="toggleNarracion()"
    style="position: fixed; left: 15px; bottom: 15px; padding: 12px 18px;
           background-color: #ff85c0; border: none; border-radius: 12px;
           font-weight: bold; color: white; box-shadow: 2px 2px 8px rgba(0,0,0,0.2);
           cursor: pointer; z-index: 999;">
     Narraci贸n Desactivada
</button>

<script>
//  Estado de narraci贸n, se guarda en localStorage
let narracionActiva = localStorage.getItem("narracionActiva") === "true";
let narrando = false;

//  Al cargar la p谩gina, actualizar bot贸n y leer si es necesario
window.addEventListener("DOMContentLoaded", () => {
    actualizarBotonNarracion();

    //  Si el juego termin贸 (nivel final)
    {% if finished %}
        if(narracionActiva) {
            leerTexto("隆Felicidades, has completado el juego!");
        }
        return; // No seguir leyendo nada m谩s
    {% endif %}

    //  Nivel 1: bienvenida + descripci贸n
    {% if level_num == 1 and not message %}
        if(narracionActiva) {
            leerTexto("Bienvenido al juego. Escribe la palabra correcta seg煤n la descripci贸n.");
            setTimeout(() => {
                leerNivelYDescripcion();
            }, 1500); // Peque帽o retraso para separar mensajes
        }
    {% else %}
        //  Niveles 2 a 10: solo descripci贸n
        if(narracionActiva) {
            leerNivelYDescripcion();
        }
    {% endif %}

    //  Leer feedback si existe
    {% if message %}
        if(narracionActiva) {
            setTimeout(() => { leerTexto("{{ message }}"); }, 500);
        }
    {% endif %}
});

//  Funci贸n TTS
function leerTexto(texto) {
    if (!narracionActiva || narrando) return;
    narrando = true;

    const utter = new SpeechSynthesisUtterance(texto);
    utter.lang = "es-ES";
    utter.rate = 1;
    utter.onend = () => narrando = false;
    speechSynthesis.speak(utter);
}

//  Leer nivel actual + descripci贸n
function leerNivelYDescripcion() {
    const descripcion = document.querySelector(".frase-box-pretty p")?.textContent || "{{ descripcion }}";
    leerTexto(`Nivel {{ level_num }}. Escribe la palabra. Descripci贸n: ${descripcion}`);
}

//  Activar / desactivar narraci贸n
function toggleNarracion() {
    narracionActiva = !narracionActiva;
    localStorage.setItem("narracionActiva", narracionActiva);
    actualizarBotonNarracion();

    if (narracionActiva && !({{ finished|yesno:"true,false" }})) {
        leerNivelYDescripcion();
    }
}

//  Actualizar texto del bot贸n
function actualizarBotonNarracion() {
    const btn = document.getElementById("btnNarracion");
    btn.textContent = narracionActiva ? " Narrador Activado" : " Narrador Desactivado";
}

//  Detener la voz al cambiar de p谩gina
window.addEventListener("beforeunload", function () {
    window.speechSynthesis.cancel();
});
</script>

{% endblock %}
