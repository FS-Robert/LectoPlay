{% extends "home.html" %}

{% block title %}Lectura R√°pida{% endblock %}

{% block content %}
<script>
//  Estado de narraci√≥n, se guarda en localStorage
let narracionActiva = localStorage.getItem("narracionActiva") === "true";  // Recuperar estado
let narrando = false;

///  Al cargar la p√°gina
window.addEventListener("DOMContentLoaded", () => {
    actualizarBotonNarracion();

    //  SOLO en categor√≠a (antes de empezar el juego)
    {% if not categoria_actual %}
        // Peque√±o delay para asegurar que la p√°gina carg√≥ bien
        setTimeout(() => {
             leerTexto("Bienvenido a Lectura r√°pida. Elige una categor√≠a para empezar.");
        }, 500);
    {% else %}
        if (narracionActiva) {
            leerCategoriaYFrase(); 
        }
    {% endif %}
});

//  Leer texto simple
function leerTexto(texto) {
    if (!narracionActiva && !texto.includes("Bienvenido")) return; 
    if (!narracionActiva) return;
    
    window.speechSynthesis.cancel(); // Limpiar cola
    const utter = new SpeechSynthesisUtterance(texto);
    utter.lang = "es-ES";
    utter.rate = 0.9; // Un poco m√°s lento para ni√±os
    window.speechSynthesis.speak(utter);
}

//  Activar / desactivar narraci√≥n
function toggleNarracion() {
    narracionActiva = !narracionActiva;
    localStorage.setItem("narracionActiva", narracionActiva); 
    actualizarBotonNarracion();

    if (narracionActiva) {
        //  Leer contexto actual
        if (document.getElementById("fraseTexto")) {
            leerCategoriaYFrase();
        } else {
            leerTexto("Narraci√≥n activada.");
        }
    } else {
        window.speechSynthesis.cancel();
    }
}

//  Leer TODO EL CONTEXTO DEL JUEGO
function leerCategoriaYFrase() {
    const categoria = "{{ categoria_actual }}";
    const frase = document.getElementById("fraseTexto")?.textContent || "";
    // Construir texto limpio para leer
    let texto = "Categor√≠a: " + categoria + ". . Frase: " + frase + ". . Pregunta: {{ pregunta }}. . Opciones: ";

    {% for opcion in opciones %}
        texto += "{{ opcion }}, . ";
    {% endfor %}

    leerTexto(texto);
}

//  Cambiar el texto del bot√≥n visualmente
function actualizarBotonNarracion() {
    const btn = document.getElementById("btnNarracion");
    if(btn) {
        btn.innerHTML = narracionActiva ? "üîä Narraci√≥n Activada" : "üîá Narraci√≥n Desactivada";
        btn.style.backgroundColor = narracionActiva ? "#4cc9f0" : "#ff85c0"; // Cambio de color visual
    }
}
</script>

<div class="container py-5">
    
    <div class="text-center mb-5">
        <h1 class="fw-bold" style="color: #023047; font-size: 2.5rem;">üìñ Lectura R√°pida</h1>
        <p class="lead text-muted">Lee frases cortas y responde preguntas para mejorar tu comprensi√≥n.</p>
    </div>

    {% if not categoria_actual %}
        <div class="categories-section">
            <h3 class="text-center mb-4" style="color: #219ebc;">‚ú® Elige un tema para empezar:</h3>
            
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 justify-content-center">
                {% for cat in categorias %}
                    <div class="col col-category">
                        <div class="category-card">
                            <div class="cat-icon">üìö</div>
                            
                            <h3 class="cat-title">{{ cat }}</h3>
                            <p class="cat-desc">Divi√©rtete con frases y preguntas sobre <strong>{{ cat }}</strong>.</p>
                            
                            <form method="get" action="">
                                <input type="hidden" name="categoria" value="{{ cat }}">
                                <button type="submit" class="btn-cat-start">
                                    Jugar Ahora ‚ñ∂
                                </button>
                            </form>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

    {% else %}
        <div class="lectura-bg mt-4">
            
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="badge rounded-pill bg-warning text-dark fs-6 px-3 py-2 shadow-sm">
                    ‚≠ê Aciertos: {{ aciertos }} / {{ intentos }}
                </span>
                <a href="{% url 'lectura_rapida_game' %}" class="btn btn-sm btn-outline-secondary rounded-pill">
                    ‚Ü© Cambiar tema
                </a>
            </div>

            <div class="lectura-card text-center">
                <h4 class="titulo-categoria mb-3">Tema: <span style="color:#023047">{{ categoria_actual }}</span></h4>

                <div class="frase-box-pretty my-4">
                    <p class="mb-0 fs-4 text-dark" id="fraseTexto" style="line-height: 1.6;">{{ frase }}</p>
                </div>

                <div class="mt-4">
                    <p class="fs-5 fw-bold" style="color:#d74b76;">‚ùì {{ pregunta }}</p>
                </div>

                <form method="post" class="mt-4">
                    {% csrf_token %}
                    
                    <div class="d-flex flex-column align-items-center gap-2 mb-4">
                        {% for opcion in opciones %}
                            <label class="btn btn-outline-primary w-100 py-2 rounded-3 border-2 fw-bold text-start px-4" 
                                   style="max-width: 400px; transition:0.2s;">
                                <input type="radio" name="respuesta" value="{{ opcion }}" required class="me-2 form-check-input">
                                {{ opcion }}
                            </label>
                        {% endfor %}
                    </div>

                    <input type="hidden" name="correcta" value="{{ correcta }}">
                    <input type="hidden" name="categoria" value="{{ categoria_actual }}">

                    <div class="d-flex justify-content-center gap-3">
                        <button type="submit" class="btn btn-lg btn-success rounded-pill px-5 fw-bold shadow-sm" name="action" value="responder">
                            ‚úÖ Responder
                        </button>
                        
                        <button type="submit" class="btn btn-light text-muted rounded-pill px-3" name="action" value="otra" title="Saltar frase">
                            Saltar ‚û°
                        </button>
                    </div>
                </form>
                
                {% if feedback %}
                    <div class="alert alert-info mt-3 rounded-3 fw-bold">
                        {{ feedback }}
                    </div>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>

<button id="btnNarracion" onclick="toggleNarracion()"
    class="shadow"
    style="
        position: fixed;
        left: 20px;
        bottom: 20px;
        padding: 12px 20px;
        background-color: #ff85c0;
        border: none;
        border-radius: 50px;
        font-weight: bold;
        color: white;
        cursor: pointer;
        z-index: 999;
        transition: 0.3s;
        font-size: 0.9rem;
    ">
    üîá Narraci√≥n Desactivada
</button>

<script>
window.addEventListener("beforeunload", function () {
    window.speechSynthesis.cancel();
});
</script>

{% endblock %}