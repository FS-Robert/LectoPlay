{% extends "home.html" %}

{% block title %}Lectura R谩pida{% endblock %}

{% block content %}
<script>
//  Estado de narraci贸n, se guarda en localStorage
let narracionActiva = localStorage.getItem("narracionActiva") === "true";  // Recuperar estado
let narrando = false;

//  Al cargar la p谩gina, actualizar bot贸n y leer si es necesario
window.addEventListener("DOMContentLoaded", () => {
    actualizarBotonNarracion();

    //  SOLO en categor铆a (antes de empezar el juego)
    {% if not categoria_actual %}
        leerTexto("Lectura r谩pida. Lee frases cortas y responde preguntas para mejorar tu comprensi贸n.");
    {% else %}
        if (narracionActiva) {
            leerCategoriaYFrase();  //  AQU SE LEE TODO LO PEDIDO
        }
    {% endif %}
});

//  Leer texto
function leerTexto(texto) {
    if (!narracionActiva || narrando) return;
    narrando = true;

    const utter = new SpeechSynthesisUtterance(texto);
    utter.lang = "es-ES";
    utter.rate = 1;
    utter.onend = () => narrando = false;
    speechSynthesis.speak(utter);
}

//  Activar / desactivar narraci贸n
function toggleNarracion() {
    narracionActiva = !narracionActiva;
    localStorage.setItem("narracionActiva", narracionActiva); 
    actualizarBotonNarracion();

    if (narracionActiva && document.getElementById("fraseTexto")) {
        leerCategoriaYFrase();
    }
}

//  Leer CATEGORA + FRASE + PREGUNTA + OPCIONES 
function leerCategoriaYFrase() {
    const categoria = "{{ categoria_actual }}";
    const frase = document.getElementById("fraseTexto")?.textContent || "";
    let texto = "Categor铆a: " + categoria + ". Frase: " + frase + ". Pregunta: {{ pregunta }}. Opciones: ";

    {% for opcion in opciones %}
        texto += "{{ opcion }}, ";
    {% endfor %}

    leerTexto(texto);
}

//  Cambiar el texto del bot贸n
function actualizarBotonNarracion() {
    const btn = document.getElementById("btnNarracion");
    btn.textContent = narracionActiva ? " Narraci贸n Activada" : " Narraci贸n Desactivada";
}
</script>


<div class="ejercicios">
    <h1> Lectura R谩pida</h1>
    <p>Lee frases cortas y responde preguntas para mejorar tu comprensi贸n.</p>

    {% if not categoria_actual %}
        <!--  CATEGORAS (solo lee la intro) -->
        <h2>Elige una categor铆a</h2>
        <div class="cards">
            {% for cat in categorias %}
                <div class="card">
                    <h3>{{ cat }}</h3>
                    <p>Frases y preguntas de <strong>{{ cat }}</strong>.</p>
                    <form method="get">
                        <input type="hidden" name="categoria" value="{{ cat }}">
                        <button type="submit" class="btn">Empezar</button>
                    </form>
                </div>
            {% endfor %}
        </div>

    {% else %}
        <!--  EJERCICIO -->
        <div class="lectura-bg">
            <div class="score-pretty">Aciertos: {{ aciertos }} / {{ intentos }}</div>

            <div class="lectura-card">
                <h2 class="titulo-categoria">Categor铆a: {{ categoria_actual }}</h2>

                <div class="frase-box-pretty">
                    <strong>Frase:</strong>
                    <p id="fraseTexto">{{ frase }}</p>
                </div>

                <p><strong>Pregunta:</strong> {{ pregunta }}</p>

                <form method="post">
                    {% csrf_token %}
                    <div class="opciones-container">
                        {% for opcion in opciones %}
                            <label class="opcion-linea">
                                <input type="radio" name="respuesta" value="{{ opcion }}" required>
                                {{ opcion }}
                            </label>
                        {% endfor %}
                    </div>

                    <input type="hidden" name="correcta" value="{{ correcta }}">
                    <input type="hidden" name="categoria" value="{{ categoria_actual }}">

                    <div class="btn-row">
                        <button type="submit" class="btn" name="action" value="responder">Responder</button>
                        <button type="submit" class="btn" name="action" value="otra">Otra frase</button>
                        <a href="{% url 'lectura_rapida_game' %}" class="btn">Cambiar categor铆a</a>
                    </div>
                </form>
            </div>
        </div>
    {% endif %}
</div>

<!--  BOTN FLOTANTE -->
<button id="btnNarracion" onclick="toggleNarracion()"
    style="
        position: fixed;
        left: 15px;
        bottom: 15px;
        padding: 12px 18px;
        background-color: #ff85c0;
        border: none;
        border-radius: 12px;
        font-weight: bold;
        color: white;
        box-shadow: 2px 2px 8px rgba(0,0,0,0.2);
        cursor: pointer;
        z-index: 999;
    ">
     Narraci贸n Desactivada
</button>

<!--  DETENER LA VOZ AL CAMBIAR DE PGINA -->
<script>
window.addEventListener("beforeunload", function () {
    window.speechSynthesis.cancel();
});
</script>

{% endblock %}
