{% extends "home.html" %}
{% load static %}

{% block title %}Palabra o no palabra | LectoPlay{% endblock %}

{% block content %}

<div class="container py-5">
    
    <div class="text-center mb-4">
        <h1 class="fw-bold" style="color: #00b4d8;">Palabra o no Palabra</h1>
        <p class="lead text-muted">Elige cuál de las opciones es una palabra real.</p>
    </div>

    {% if finished %}
        <div class="game-bg-pnp text-center">
            <h2 class="fw-bold text-success mb-3">¡Misión Cumplida!</h2>
            
            <div class="p-4 bg-white rounded-4 shadow-sm d-inline-block mb-4">
                <p class="mb-0 fs-4 text-secondary">Puntuación Final</p>
                <p class="display-4 fw-bold" style="color: #00b4d8;">{{ score }} <span class="fs-4 text-muted">/ {{ total }}</span></p>
            </div>

            <form method="post">
                {% csrf_token %}
                <button name="reset" value="1" class="btn btn-lg text-white rounded-pill px-5 fw-bold shadow-sm" style="background-color: #00b4d8;">
                    Jugar de nuevo
                </button>
            </form>
        </div>

    {% else %}
        <div class="game-bg-pnp text-center">
            
            <div class="d-flex justify-content-between align-items-center mb-4 px-2">
                <span class="badge bg-light text-dark border px-3 py-2 rounded-pill fs-6">
                    Nivel {{ level_num }} / {{ total }}
                </span>
                <span class="badge bg-warning text-dark px-3 py-2 rounded-pill fs-6">
                    Puntos: {{ score }}
                </span>
            </div>

            <h2 class="pnp-question">¿Cuál es la palabra real?</h2>

            <form method="post" id="pnpForm">
                {% csrf_token %}
                <div class="pnp-options-container">
                    {% for palabra in opciones %}
                        <button type="submit" name="choice" value="{{ palabra }}" class="btn-word-option">
                            {{ palabra }}
                        </button>
                    {% endfor %}
                </div>
            </form>

            {% if message %}
                <div class="mt-4 alert alert-danger fw-bold d-inline-block px-4 py-2 rounded-pill animate__animated animate__shakeX">
                    {{ message }}
                </div>
            {% endif %}
            
            <form method="post" class="mt-4">
                {% csrf_token %}
                <button name="reset" value="1" class="btn btn-sm btn-link text-secondary text-decoration-none">
                    Reiniciar juego
                </button>
            </form>
        </div>
    {% endif %}

</div>

<button id="btnNarracion" onclick="toggleNarracion()"
    class="shadow"
    style="
        position: fixed; left: 20px; bottom: 20px; padding: 12px 20px;
        background-color: #ff85c0; border: none; border-radius: 50px;
        font-weight: bold; color: white; cursor: pointer; z-index: 999;
        transition: 0.3s; font-size: 0.9rem;
    ">
    Narrador Desactivado
</button>

{% endblock %}

{% block extra_js %}
<script>
    // Estado de TTS persistente
    let narracionActiva = localStorage.getItem("narracionActiva") === "true";
    
    // Variables seguras
    const isFinished = "{{ finished|yesno:'true,false' }}" === "true";
    const level = {{ level_num|default:"0" }};
    const message = "{{ message|default:''|escapejs }}";
    
    // Construir lista de opciones para leer
    const opcionesLista = [];
    {% if opciones %}
        {% for palabra in opciones %}
            opcionesLista.push("{{ palabra|escapejs }}");
        {% endfor %}
    {% endif %}

    const btn = document.getElementById("btnNarracion");

    // Actualizar boton
    function updateButton() {
        if(btn) {
            btn.textContent = narracionActiva ? "Narrador Activado" : "Narrador Desactivado";
            btn.style.backgroundColor = narracionActiva ? "#4cc9f0" : "#ff85c0";
        }
    }
    updateButton();

    // Toggle Narracion
    function toggleNarracion() {
        narracionActiva = !narracionActiva;
        localStorage.setItem("narracionActiva", narracionActiva);
        updateButton();
        
        if (!narracionActiva) {
            window.speechSynthesis.cancel();
        } else {
            leerEstadoJuego();
        }
    }

    // Funcion TTS
    function leerTexto(text) {
        if (!narracionActiva) return;
        if (!('speechSynthesis' in window)) return;

        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = "es-ES";
        msg.rate = 0.9; 
        window.speechSynthesis.speak(msg);
    }

    // Logica de lectura
    function leerEstadoJuego() {
        if (isFinished) {
            leerTexto("Misión cumplida. Has completado el juego.");
            return;
        }

        // Construir texto de las opciones
        const textoOpciones = opcionesLista.join(", o, ");

        // 1. Si hay feedback (Error), leerlo primero
        if (message) {
            leerTexto(message);
            
            // 2. Leer la pregunta de nuevo tras el error (opcional)
            /* setTimeout(() => {
                leerTexto("Elige cuál es la palabra real: " + textoOpciones);
            }, 1500); */
        } else {
            // Juego Normal
            let intro = "¿Cuál es la palabra real?";
            
            // Si es nivel 1, ser mas explicito
            if (level === 1) {
                intro = "Bienvenido. Palabra o no palabra. " + intro;
            }
            
            leerTexto(`${intro}. Las opciones son: ${textoOpciones}.`);
        }
    }

    // Al cargar la pagina
    setTimeout(() => {
        if (narracionActiva) {
            leerEstadoJuego();
        }
    }, 500);

    // Detener al salir
    window.addEventListener("beforeunload", () => {
        window.speechSynthesis.cancel();
    });
</script>
{% endblock %}