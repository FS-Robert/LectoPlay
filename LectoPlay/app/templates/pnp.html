{% extends "home.html" %}

{% block title %}Palabra o no palabra | LectoPlay{% endblock %}

{% block content %}
<section class="ejercicios">
    <h1>âœ… Palabra o no palabra</h1>
    <p>Elige cuÃ¡l de las opciones es una palabra real.</p>

    {% if finished %}
        <div class="lectura-bg">
            <div class="lectura-card" style="text-align:center;">
                <p>Has completado el juego.</p>
                <p>PuntuaciÃ³n final: <strong>{{ score }}</strong> / {{ total }}</p>
                <form method="post">
                    {% csrf_token %}
                    <button type="submit" name="reset" value="1" class="btn">Jugar de nuevo</button>
                </form>
            </div>
        </div>
    {% else %}
        <div class="lectura-bg">
            <div class="score-pretty">
                Nivel {{ level_num }} / {{ total }} &nbsp; | &nbsp; Puntos: {{ score }}
            </div>

            <div class="lectura-card">
                <h2 class="titulo-categoria">Â¿CuÃ¡l es la palabra real?</h2>

                <form method="post" id="pnpForm">
                    {% csrf_token %}
                    <div class="opciones-container">
                        {% for palabra in opciones %}
                            <button type="submit"
                                    name="choice"
                                    value="{{ palabra }}"
                                    class="btn"
                                    style="margin:6px 0; min-width:160px;">
                                {{ palabra }}
                            </button>
                        {% endfor %}
                    </div>

                    {% if message %}
                        <p class="feedback">{{ message }}</p>
                    {% endif %}
                </form>
            </div>
        </div>
    {% endif %}
</section>

<!-- ðŸŒ¸ BOTÃ“N FLOTANTE -->
<button id="btnNarracion" onclick="toggleNarracion()"
    style="position: fixed; left: 15px; bottom: 15px; padding: 12px 18px;
           background-color: #ff85c0; border: none; border-radius: 12px;
           font-weight: bold; color: white; box-shadow: 2px 2px 8px rgba(0,0,0,0.2);
           cursor: pointer; z-index: 999;">
    ðŸ”‡ NarraciÃ³n Desactivada
</button>

<script>
// ðŸ”µ Estado de narraciÃ³n
let narracionActiva = localStorage.getItem("narracionActiva") === "true";
let narrando = false;

// ðŸŸ¢ Al cargar la pÃ¡gina
window.addEventListener("DOMContentLoaded", () => {
    actualizarBotonNarracion();

    {% if finished %}
        if (narracionActiva) {
            leerTexto(`Â¡Felicidades, has completado el juego! PuntuaciÃ³n final: {{ score }} de {{ total }}.`);
        }
        return;
    {% endif %}

    // Nivel 1: descripciÃ³n + opciones en secuencia
    {% if level_num == 1 and not message %}
        if (narracionActiva) {
            const opcionesNivel1 = [{% for palabra in opciones %}"{{ palabra|escapejs }}"{% if not forloop.last %}, {% endif %}{% endfor %}];

            // Primera frase (despuÃ©s de 1s)
            setTimeout(() => {
                leerTexto(`Palabra o no palabra. Elige cuÃ¡l de las opciones es una palabra real. Las opciones son ${opcionesNivel1.join(" y ")}.`);
            }, 1000);

            // Segunda frase (despuÃ©s de 3s)
            setTimeout(() => {
                leerTexto(`CuÃ¡l es la palabra real. Las opciones son ${opcionesNivel1.join(" y ")}.`);
            }, 3000);
        }
    {% else %}
        // Nivel 2+: solo leer palabra real y opciones
        if (narracionActiva) {
            const opcionesNiveles = [{% for palabra in opciones %}"{{ palabra|escapejs }}"{% if not forloop.last %}, {% endif %}{% endfor %}];
            leerTexto(`CuÃ¡l es la palabra real. Las opciones son ${opcionesNiveles.join(" y ")}.`);
        }
    {% endif %}

    // Feedback despuÃ©s de elegir
    {% if message %}
        if (narracionActiva) {
            setTimeout(() => { leerTexto("{{ message|escapejs }}"); }, 500);
        }
    {% endif %}
});

// ðŸ“Œ FunciÃ³n TTS
function leerTexto(texto) {
    if (!narracionActiva || narrando) return;
    if (!('speechSynthesis' in window)) return; // navegadores sin soporte
    narrando = true;

    const utter = new SpeechSynthesisUtterance(texto);
    utter.lang = "es-ES";
    utter.rate = 1;
    utter.onend = () => narrando = false;
    speechSynthesis.speak(utter);
}

// Activar / desactivar narraciÃ³n
function toggleNarracion() {
    narracionActiva = !narracionActiva;
    localStorage.setItem("narracionActiva", narracionActiva);
    actualizarBotonNarracion();
}

// Actualizar botÃ³n de narraciÃ³n
function actualizarBotonNarracion() {
    const btn = document.getElementById("btnNarracion");
    btn.textContent = narracionActiva ? "ðŸ”Š Narrador Activado" : "ðŸ”‡ Narrador Desactivado";
}

// Detener TTS al salir
window.addEventListener("beforeunload", function () {
    if ('speechSynthesis' in window) window.speechSynthesis.cancel();
});
</script>

{% endblock %}