{% extends 'home.html' %}
{% load static %}

{% block title %}Palabras y Colores | LectoPlay{% endblock %}

{% block content %}
<section class="ejercicios">
    <h1> Palabras y Colores</h1>
    <p class="descripcion">Asocia la palabra con el color correcto</p>

    {% if finished %}
        <div class="result">
            <p>隆Juego completado!</p>
            <p>Puntuaci贸n final: <strong>{{ score }}</strong> / {{ total }}</p>

            <form method="post" style="margin-top:1rem;">
                {% csrf_token %}
                <button name="reset" value="1" class="btn">Jugar de nuevo</button>
            </form>
        </div>
    {% else %}
        <div class="game">
            <p>Nivel {{ level_num }} / {{ total }}</p>
            <p>Puntos: <strong>{{ score }}</strong></p>

            <div id="palabra" class="palabra" style="font-size:2rem; margin:1rem 0;">
                {{ word }}
            </div>

            {% if message %}
                <div style="color:crimson; margin:0.5rem 0; font-weight:bold;">
                    {{ message }}
                </div>
            {% endif %}

            <form method="post">
                {% csrf_token %}
                <div class="colores-opciones" style="display:flex; gap:1rem; flex-wrap:wrap; justify-content:center; margin:1.5rem 0;">
                    {% for c in choices %}
                        <button name="choice" value="{{ c }}" class="color-btn"
                            style="width:60px; height:60px; border-radius:50%; border:none; cursor:pointer; background-color: {{ c }};">
                        </button>
                    {% endfor %}
                </div>
            </form>

            <form method="post" style="margin-top:1rem;">
                {% csrf_token %}
                <button name="reset" value="1" class="btn">Reiniciar</button>
            </form>
        </div>
    {% endif %}
</section>

<!--  BOTN FLOTANTE PARA NARRACIN -->
<button id="btnNarracion" onclick="toggleNarracion()"
    style="position: fixed; left: 15px; bottom: 15px; padding: 12px 18px;
           background-color: #ff85c0; border: none; border-radius: 12px;
           font-weight: bold; color: white; box-shadow: 2px 2px 8px rgba(0,0,0,0.2);
           cursor: pointer; z-index: 999;">
     Narraci贸n Desactivada
</button>

<script>
//  Estado de narraci贸n persistente
let narracionActiva = localStorage.getItem("narracionActiva") === "true";
let narrando = false;

//  Actualizar bot贸n seg煤n estado
function actualizarBotonNarracion() {
    const btn = document.getElementById("btnNarracion");
    btn.textContent = narracionActiva ? " Narrador Activado" : " Narrador Desactivado";
}

//  Funci贸n TTS
function leerTexto(texto) {
    if (!narracionActiva || narrando) return;
    if (!('speechSynthesis' in window)) return; // si no soporta TTS
    narrando = true;

    const utter = new SpeechSynthesisUtterance(texto);
    utter.lang = "es-ES";
    utter.rate = 1;
    utter.onend = () => narrando = false;
    speechSynthesis.speak(utter);
}

// Activar / desactivar narraci贸n
function toggleNarracion() {
    narracionActiva = !narracionActiva;
    localStorage.setItem("narracionActiva", narracionActiva);
    actualizarBotonNarracion();

    // Leer palabra si activamos narraci贸n
    if (narracionActiva) {
        leerNivelYPalabra();
    }
}

// Leer nivel y palabra seg煤n reglas
function leerNivelYPalabra() {
    const wordEl = document.getElementById("palabra")?.textContent || "{{ word|escapejs }}";
    const level = {{ level_num }};
    const total = {{ total }};
    let texto = "";

    if (level === 1) {
        texto = ` Palabras y colores. Asocia la palabra con el color correcto. Nivel 1. La palabra es ${wordEl}.`;
    } else {
        texto = `Nivel ${level} de ${total}. La palabra es ${wordEl}.`;
    }

    leerTexto(texto);
}

// Inicializar al cargar la p谩gina
window.addEventListener("DOMContentLoaded", () => {
    actualizarBotonNarracion();

    {% if not finished %}
        if (narracionActiva) {
            leerNivelYPalabra();
        }
    {% endif %}
});

// Detener TTS al salir de la p谩gina
window.addEventListener("beforeunload", function () {
    if ('speechSynthesis' in window) window.speechSynthesis.cancel();
});
</script>

{% endblock %}
