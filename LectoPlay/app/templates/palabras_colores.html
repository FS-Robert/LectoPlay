{% extends 'home.html' %}
{% load static %}

{% block title %}Palabras y Colores | LectoPlay{% endblock %}

{% block content %}

<div class="container py-5">
    
    <div class="text-center mb-4">
        <h1 class="fw-bold" style="color: #ff5d8f;">üé® Palabras y Colores</h1>
        <p class="lead text-muted">Asocia la palabra escrita con su color real.</p>
    </div>

    {% if finished %}
        <div class="game-bg-colors text-center">
            <div class="display-1 mb-3">üéâ</div>
            <h2 class="fw-bold text-success mb-3">¬°Juego Completado!</h2>
            
            <div class="p-4 bg-white rounded-4 shadow-sm d-inline-block mb-4">
                <p class="mb-0 fs-4 text-secondary">Puntuaci√≥n Final</p>
                <p class="display-4 fw-bold text-primary mb-0">{{ score }} <span class="fs-4 text-muted">/ {{ total }}</span></p>
            </div>

            <form method="post">
                {% csrf_token %}
                <button name="reset" value="1" class="btn btn-lg btn-primary rounded-pill px-5 fw-bold shadow-sm">
                    üîÑ Jugar de nuevo
                </button>
            </form>
        </div>

    {% else %}
        <div class="game-bg-colors text-center">
            
            <div class="d-flex justify-content-between align-items-center mb-4 px-3">
                <span class="badge bg-light text-dark border px-3 py-2 rounded-pill fs-6">
                    Nivel {{ level_num }} / {{ total }}
                </span>
                <span class="badge bg-warning text-dark px-3 py-2 rounded-pill fs-6">
                    ‚≠ê Puntos: {{ score }}
                </span>
            </div>

            <div id="palabra" class="word-display">
                {{ word }}
            </div>

            {% if message %}
                <div class="feedback-msg feedback-error animate__animated animate__shakeX">
                    {{ message }}
                </div>
            {% endif %}

            <form method="post">
                {% csrf_token %}
                <div class="color-options-container">
                    {% for c in choices %}
                        <button type="submit" name="choice" value="{{ c }}" 
                                class="color-circle-btn"
                                style="background-color: {{ c }};"
                                aria-label="Color {{ c }}">
                        </button>
                    {% endfor %}
                </div>
            </form>

            <form method="post" class="mt-4">
                {% csrf_token %}
                <button name="reset" value="1" class="btn btn-sm btn-outline-secondary rounded-pill px-3">
                    üîÑ Reiniciar Nivel
                </button>
            </form>
        </div>
    {% endif %}

</div>

<button id="btnNarracion" onclick="toggleNarracion()"
    class="shadow"
    style="
        position: fixed; left: 20px; bottom: 20px; padding: 12px 20px;
        background-color: #ff85c0; border: none; border-radius: 50px;
        font-weight: bold; color: white; cursor: pointer; z-index: 999;
        transition: 0.3s; font-size: 0.9rem;
    ">
    üîá Narrador Desactivado
</button>

{% endblock %}

{% block extra_js %}
<script>
// üîµ Estado de narraci√≥n persistente
let narracionActiva = localStorage.getItem("narracionActiva") === "true";
let narrando = false;

// üü¢ Actualizar bot√≥n seg√∫n estado
function actualizarBotonNarracion() {
    const btn = document.getElementById("btnNarracion");
    if(btn) {
        btn.textContent = narracionActiva ? "üîä Narrador Activado" : "üîá Narrador Desactivado";
        btn.style.backgroundColor = narracionActiva ? "#4cc9f0" : "#ff85c0"; // Cambio de color visual
    }
}

// üìå Funci√≥n TTS
function leerTexto(texto) {
    if (!narracionActiva || narrando) return;
    if (!('speechSynthesis' in window)) return;
    
    window.speechSynthesis.cancel(); // Limpiar cola anterior
    narrando = true;

    const utter = new SpeechSynthesisUtterance(texto);
    utter.lang = "es-ES";
    utter.rate = 0.9;
    utter.onend = () => narrando = false;
    window.speechSynthesis.speak(utter);
}

// Activar / desactivar narraci√≥n
function toggleNarracion() {
    narracionActiva = !narracionActiva;
    localStorage.setItem("narracionActiva", narracionActiva);
    actualizarBotonNarracion();

    if (narracionActiva) {
        leerNivelYPalabra();
    } else {
        window.speechSynthesis.cancel();
    }
}

// Leer nivel y palabra
function leerNivelYPalabra() {
    // Obtenemos la palabra del HTML o desde Django
    const wordEl = document.getElementById("palabra")?.textContent.trim() || "{{ word|escapejs }}";
    const level = {{ level_num }};
    const total = {{ total }};
    let texto = "";

    // Si es el primer nivel, damos la instrucci√≥n completa
    if (level === 1) {
        texto = `Bienvenido a Palabras y colores. Asocia la palabra con el color correcto. Nivel 1. La palabra es ${wordEl}.`;
    } else {
        texto = `Nivel ${level}. La palabra es ${wordEl}.`;
    }

    leerTexto(texto);
}

// Inicializar al cargar la p√°gina
window.addEventListener("DOMContentLoaded", () => {
    actualizarBotonNarracion();

    {% if not finished %}
        // Peque√±o delay para que no choque con la carga
        setTimeout(() => {
            if (narracionActiva) {
                leerNivelYPalabra();
            }
        }, 500);
    {% else %}
        if (narracionActiva) {
            leerTexto("¬°Felicidades! Has completado todos los niveles.");
        }
    {% endif %}
});

// Detener TTS al salir
window.addEventListener("beforeunload", function () {
    if ('speechSynthesis' in window) window.speechSynthesis.cancel();
});
</script>
{% endblock %}