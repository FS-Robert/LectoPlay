{% extends "home.html" %}

{% block title %}Ver Consultas | LectoPlay{% endblock %}

{% block content %}

<h1>ðŸ“¨ Consultas de Usuarios</h1>

{% if tickets %}
<table border="1" cellpadding="10" style="width:100%; border-collapse: collapse;">
    <tr>
        <th>Usuario</th>
        <th>Email</th>
        <th>Mensaje</th>
        <th>Estado</th>
        <th>Fecha</th>
        <th>Ver</th>
    </tr>

    {% for item in tickets %}
        {% with ticket=item.ticket %}
        <tr>
            <td>{{ ticket.contacto.nombre }}</td>
            <td>{{ ticket.contacto.correo }}</td>
            <td>{{ ticket.contacto.mensaje|truncatechars:40 }}</td>

            <!-- ESTADO (se envÃ­a por GET porque la vista asÃ­ lo espera) -->
            <td>
                {% if ticket.id %}
                    <form method="get" action="{% url 'cambiar_estado' ticket.id %}">
                        <select name="estado" onchange="this.form.submit()">
                            <option value="pendiente" {% if ticket.estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
                            <option value="respondido" {% if ticket.estado == 'respondido' %}selected{% endif %}>Respondido</option>
                            <option value="finalizado" {% if ticket.estado == 'finalizado' %}selected{% endif %}>Finalizado</option>
                        </select>
                    </form>
                {% else %}
                    <span style="color:red;">Ticket corrupto (sin ID)</span>
                {% endif %}
            </td>

            <td>{{ ticket.creado|date:"d/m/Y H:i" }}</td>

            <td>
                {% if ticket.id %}
                    <a href="{% url 'consulta_detalle' ticket.id %}">
                        Abrir chat
                    </a>
                {% else %}
                    <span>Error</span>
                {% endif %}
            </td>
        </tr>
        {% endwith %}
    {% endfor %}
</table>

{% else %}
<p>No hay consultas todavÃ­a.</p>
{% endif %}

{% endblock %}
