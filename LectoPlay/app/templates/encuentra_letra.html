{% extends 'home.html' %}

{% block title %}Encuentra la Letra | LectoPlay{% endblock %}

{% block content %}
<section class="ejercicios">
    <h1>游댟 Encuentra la Letra</h1>

    <!-- BOT칍N PARA ACTIVAR/DESACTIVAR NARRADOR -->
    <button id="toggle-tts" class="btn"
            style="position: fixed; bottom: 20px; left: 20px; z-index: 999;">
        Activar Narrador
    </button>

    {% if finished %}
        <div class="result">
            <p>춰Has completado el juego!</p>
            <p>Puntuaci칩n final: <strong>{{ score }}</strong> / {{ total }} niveles</p>
            <form method="post" style="margin-top:1rem;">
                {% csrf_token %}
                <button name="reset" value="1" class="btn">Jugar de nuevo</button>
            </form>
        </div>
    {% else %}
        <div class="game">
            <p>Nivel {{ level_num }} / {{ total }}</p>
            <p>Puntos: <strong>{{ score }}</strong></p>

            <!-- PALABRA COMO BOTONES -->
            <div style="margin-top:1rem; font-size:1.6rem;">
                <div>Palabra:
                    <form method="post" id="word-form" style="display:inline-block; margin-left:0.5rem;">
                        {% csrf_token %}
                        {% for ch in word %}
                            <button type="submit" name="choice" value="{{ ch }}" class="letter-btn" aria-label="Letra {{ ch }}">
                                {{ ch|upper }}
                            </button>
                        {% endfor %}
                    </form>
                </div>

                <!-- LETRA OBJETIVO -->
                <div style="margin-top:0.5rem;">
                    Encuentra la letra: <strong id="target-letter">{{ target|upper }}</strong>
                </div>
            </div>

            {% if message %}
                <div style="color:crimson; margin-top:0.5rem; font-weight:bold;">{{ message }}</div>
            {% endif %}

            <form method="post" style="margin-top:0.5rem;">
                {% csrf_token %}
                <button name="reset" value="1" class="btn">Reiniciar</button>
            </form>
        </div>
    {% endif %}
</section>

<script>
    // 游댯 Estado de TTS persistente
    let ttsActive = localStorage.getItem("ttsActive") === "true";
    let level = {{ level_num }};
    let word = "{{ word }}";
    let target = "{{ target }}";

    const btn = document.getElementById("toggle-tts");

    // Actualizar texto del bot칩n seg칰n estado
    function updateButton() {
        btn.textContent = ttsActive ? "游댆 Desactivar Narrador" : "游댉 Activar Narrador";
    }
    updateButton();

    // Activar/Desactivar TTS
    btn.addEventListener("click", () => {
        ttsActive = !ttsActive;
        localStorage.setItem("ttsActive", ttsActive); // Persistencia entre niveles
        updateButton();
        if (!ttsActive) stopVoice();
        else speak(level === 1
            ? `Encuentra la letra. La palabra es ${word}. Debes encontrar la letra ${target}.`
            : `La palabra es ${word}. Busca la letra ${target}`);
    });

    // Detener TTS
    function stopVoice() {
        window.speechSynthesis.cancel();
    }

    // Funci칩n TTS
    function speak(text) {
        if (!ttsActive) return;
        stopVoice();
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = "es-ES";
        msg.rate = 0.9;
        msg.pitch = 1.2;
        window.speechSynthesis.speak(msg);
    }

    // 游댯 Al cargar la p치gina, leer autom치ticamente si TTS activo
    if (ttsActive) {
        let text = level === 1
            ? `Encuentra la letra. La palabra es ${word}. Debes encontrar la letra ${target}.`
            : `La palabra es ${word}. Busca la letra ${target}`;
        speak(text);
    }

    // 游댯 Detener TTS al cambiar de p치gina
    window.addEventListener("beforeunload", stopVoice);
</script>

{% endblock %}
