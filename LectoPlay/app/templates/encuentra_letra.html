{% extends 'home.html' %}
{% load static %}

{% block title %}Encuentra la Letra | LectoPlay{% endblock %}

{% block content %}

<div class="container py-5">
    
    <div class="text-center mb-4">
        <h1 class="fw-bold" style="color: #fb8500;">üî§ Encuentra la Letra</h1>
        <p class="lead text-muted">Busca y selecciona la letra correcta dentro de la palabra.</p>
    </div>

    {% if finished %}
        <div class="game-bg-letters text-center">
            <div class="display-1 mb-3">üéâ</div>
            <h2 class="fw-bold text-success mb-3">¬°Misi√≥n Cumplida!</h2>
            
            <div class="p-4 bg-white rounded-4 shadow-sm d-inline-block mb-4">
                <p class="mb-0 fs-4 text-secondary">Puntuaci√≥n Final</p>
                <p class="display-4 fw-bold text-warning mb-0">{{ score }} <span class="fs-4 text-muted">/ {{ total }}</span></p>
            </div>

            <form method="post">
                {% csrf_token %}
                <button name="reset" value="1" class="btn btn-lg btn-warning text-white rounded-pill px-5 fw-bold shadow-sm">
                    üîÑ Jugar de nuevo
                </button>
            </form>
        </div>

    {% else %}
        <div class="game-bg-letters text-center">
            
            <div class="d-flex justify-content-between align-items-center mb-4 px-3">
                <span class="badge bg-light text-dark border px-3 py-2 rounded-pill fs-6">
                    Nivel {{ level_num }} / {{ total }}
                </span>
                <span class="badge bg-primary text-white px-3 py-2 rounded-pill fs-6">
                    ‚≠ê Puntos: {{ score }}
                </span>
            </div>

            <div class="target-instruction">
                Encuentra la letra: 
                <span class="target-letter-display">{{ target|upper }}</span>
            </div>

            <form method="post" id="word-form">
                {% csrf_token %}
                <div class="word-container">
                    {% for ch in word %}
                        <button type="submit" name="choice" value="{{ ch }}" class="letter-btn" aria-label="Letra {{ ch }}">
                            {{ ch|upper }}
                        </button>
                    {% endfor %}
                </div>
            </form>

            {% if message %}
                <div class="alert alert-danger fw-bold d-inline-block px-4 py-2 rounded-pill animate__animated animate__shakeX">
                    {{ message }}
                </div>
            {% endif %}

            <form method="post" class="mt-4">
                {% csrf_token %}
                <button name="reset" value="1" class="btn btn-sm btn-outline-secondary rounded-pill px-3">
                     Reiniciar Nivel
                </button>
            </form>
        </div>
    {% endif %}

</div>

<button id="btnNarracion" onclick="toggleNarracion()"
    class="shadow"
    style="
        position: fixed; left: 20px; bottom: 20px; padding: 12px 20px;
        background-color: #ff85c0; border: none; border-radius: 50px;
        font-weight: bold; color: white; cursor: pointer; z-index: 999;
        transition: 0.3s; font-size: 0.9rem;
    ">
    üîá Narrador Desactivado
</button>

{% endblock %}

{% block extra_js %}
<script>
    //  Estado de TTS persistente (Estandarizado a 'narracionActiva')
    let narracionActiva = localStorage.getItem("narracionActiva") === "true";
    
    //  Inicializaci√≥n segura de variables para evitar errores de sintaxis
    // Usamos |default para que si Django no env√≠a el dato, JS reciba un valor seguro
    const isFinished = "{{ finished|yesno:'true,false' }}" === "true";
    const level = {{ level_num|default:"0" }};
    const word = "{{ word|default:'' }}";
    const target = "{{ target|default:'' }}";

    const btn = document.getElementById("btnNarracion");

    // Actualizar texto del bot√≥n
    function updateButton() {
        if(btn) {
            btn.textContent = narracionActiva ? "üîä Narrador Activado" : "üîá Narrador Desactivado";
            btn.style.backgroundColor = narracionActiva ? "#4cc9f0" : "#ff85c0";
        }
    }
    
    // Inicializar
    updateButton();

    // Funci√≥n Hablar
    function leerTexto(text) {
        if (!narracionActiva) return;
        if (!('speechSynthesis' in window)) return;

        window.speechSynthesis.cancel(); // Limpiar cola
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = "es-ES";
        msg.rate = 0.9;
        msg.pitch = 1.1; 
        window.speechSynthesis.speak(msg);
    }

    // Toggle Narraci√≥n
    function toggleNarracion() {
        narracionActiva = !narracionActiva;
        localStorage.setItem("narracionActiva", narracionActiva);
        updateButton();
        
        if (!narracionActiva) {
            window.speechSynthesis.cancel();
        } else {
            // Leer inmediatamente al activar
            generarInstruccion();
        }
    }

    // Generar texto seg√∫n estado del juego
    function generarInstruccion() {
        if (isFinished) {
            leerTexto("¬°Misi√≥n cumplida! Has completado todos los niveles.");
        } else {
            let texto = "";
            if (level === 1) {
                // Instrucci√≥n completa para nivel 1
                texto = `Encuentra la letra. La palabra es ${word}. Debes encontrar la letra ${target}.`;
            } else {
                // Instrucci√≥n corta para siguientes niveles
                texto = `La palabra es ${word}. Busca la letra ${target}`;
            }
            leerTexto(texto);
        }
    }

    // Al cargar la p√°gina, leer autom√°ticamente con peque√±o delay
    setTimeout(() => {
        if (narracionActiva) {
            generarInstruccion();
        }
    }, 500);

    //  Detener TTS al cambiar de p√°gina
    window.addEventListener("beforeunload", () => {
        window.speechSynthesis.cancel();
    });
</script>
{% endblock %}